#################################################
# Backup / Restore
#################################################

- name: Install ssh key id_ed25519-backup_raspi.xvx.cz{.pub}
  ansible.builtin.copy:
    src: files/{{ item }}
    dest: "{{ item }}"
    mode: u=rw,g=,o=
    owner: root
  loop:
    - /root/.ssh/id_ed25519-backup_raspi.xvx.cz
    - /root/.ssh/id_ed25519-backup_raspi.xvx.cz.pub
  no_log: true

- name: Creates Backup Prometheus file /etc/cron.d/backup-prometheus
  ansible.builtin.cron:
    name: Backup Prometheus
    weekday: "*"
    minute: "0"
    hour: "3"
    user: root
    job: PROMETHEUS_SNAPSHOT_DIR=$(curl -s -X POST http://127.0.0.1:9090/api/v1/admin/tsdb/snapshot | jq -r '.data.name') && rsync --archive --verbose --delete --log-file=/tmp/backup-prometheus.log -e 'ssh -i /root/.ssh/id_ed25519-backup_raspi.xvx.cz -o StrictHostKeyChecking=no' /var/lib/prometheus/snapshots/${PROMETHEUS_SNAPSHOT_DIR}/ {{ backup_user }}@{{ backup_server }}:{{ backup_directory }}/prometheus/ > /dev/null && rm -rf /var/lib/prometheus/snapshots
    cron_file: backup-prometheus

# - name: Creates Backup HASS file /etc/cron.d/backup-hass
#   ansible.builtin.cron:
#     name: Backup Home Assistant
#     weekday: "*"
#     minute: "0"
#     hour: "3"
#     user: root
#     job: HASS_BACKUP_FILE=$(ls -t {{ hass_config_directory }}/backups/*.tar | head -1) && rsync --archive --verbose --delete --log-file=/tmp/backup-hass.log --rsh='ssh -i /root/.ssh/id_ed25519-backup_raspi.xvx.cz -o StrictHostKeyChecking=no' "${HASS_BACKUP_FILE}" "{{ backup_user }}@{{ backup_server }}:{{ backup_directory }}/hass_config/hass_config_latest_backup.tar" > /dev/null && rm {{ hass_config_directory }}/backups/*.tar
#     cron_file: backup-hass

- name: Check if /var/log/restore-prometheus.log exists
  ansible.builtin.stat:
    path: /var/log/restore-prometheus.log
  register: prometheus_restore_log

- name: Restore Prometheus from backup
  when: not prometheus_restore_log.stat.exists
  block:
    - name: Stop Prometheus
      ansible.builtin.systemd_service:
        name: prometheus
        state: stopped

    - name: Restore Prometheus from backup # noqa: command-instead-of-module
      ansible.builtin.shell: |
        rsync --archive --verbose --chown=prometheus:prometheus --delete --log-file=/var/log/restore-prometheus.log --rsh='ssh -i /root/.ssh/id_ed25519-backup_raspi.xvx.cz -o StrictHostKeyChecking=no' {{ backup_user }}@{{ backup_server }}:{{ backup_directory }}/prometheus/ /var/lib/prometheus/
      changed_when: true

    - name: Start Prometheus
      ansible.builtin.systemd_service:
        name: prometheus
        state: started
  rescue:
    - name: Print when errors
      ansible.builtin.fail:
        msg: Restore from backup failed

- name: Check if /var/log/restore-hass.log exists
  ansible.builtin.stat:
    path: /var/log/restore-hass.log
  register: hass_restore_log

- name: Create HASS directory (/var/lib/hass_config)
  when: not hass_restore_log.stat.exists
  ansible.builtin.file:
    path: /var/lib/hass_config/blueprints/automation/homeassistant
    state: directory
    recurse: true

# - name: Restore HASS from backup # noqa: command-instead-of-module
#   when: not hass_restore_log.stat.exists
#   ansible.builtin.shell: |
#     set -o pipefail
#     ssh -i /root/.ssh/id_ed25519-backup_raspi.xvx.cz -o StrictHostKeyChecking=no {{ backup_user }}@{{ backup_server }} 'cat {{ backup_directory }}/hass_config/hass_config_latest_backup.tar' | tar -xf - homeassistant.tar.gz --to-stdout | tar xvzf - -C "{{ hass_config_directory }}" --wildcards "data/home-assistant*" --strip-components=1 > /var/log/restore-hass.log
#   args:
#     executable: /bin/bash
#   changed_when: true

#################################################
# Docker
#################################################

- name: Add Docker apt signing keys
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /usr/share/keyrings/docker.gpg
    mode: u=rw,g=r,o=r

- name: Add Docker repository
  ansible.builtin.deb822_repository:
    name: docker
    uris: https://download.docker.com/linux/debian
    suites: "{{ ansible_distribution_release }}"
    components: stable
    signed_by: /usr/share/keyrings/docker.gpg

- name: Create Docker daemon configuration directory
  ansible.builtin.file:
    path: /etc/docker
    state: directory
    mode: u=rwx,g=rx,o=rx

- name: Configure Docker daemon
  ansible.builtin.copy:
    dest: /etc/docker/daemon.json
    content: |
      {{ docker_config | to_nice_json }}
    mode: u=rw,g=r,o=r
  notify: Restart docker

- name: Install docker
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
    update_cache: true
    install_recommends: false
  register: result
  until: result is succeeded

- name: Start and enable Docker service
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true
    daemon_reload: true

- name: Add pi and alloy users to the docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: docker
    append: true
  loop:
    - pi
    - alloy

#################################################
# Prometheus
#################################################

# - name: Create HASS scape config for Prometheus (/etc/prometheus/scrape_configs/hass.yml)
#   ansible.builtin.copy:
#     dest: /etc/prometheus/scrape_configs/hass.yml
#     content: |
#       scrape_configs:
#         - job_name: hass
#           scrape_interval: 60s
#           metrics_path: /api/prometheus
#           bearer_token: "{{ prometheus_hass_bearer_token }}"
#           static_configs:
#             - targets:
#                 - 127.0.0.1:8123
#     mode: u=rw,g=,o=
#     owner: prometheus
#     group: prometheus
#   no_log: true
#   notify: Restart prometheus

#################################################
# Cloudflared
#################################################

- name: Add Cloudflare apt signing keys
  ansible.builtin.get_url:
    url: https://pkg.cloudflare.com/cloudflare-main.gpg
    dest: /usr/share/keyrings/cloudflare-main.gpg
    mode: u=rw,g=r,o=r

- name: Add Cloudflare repository
  ansible.builtin.deb822_repository:
    name: cloudflared
    uris: https://pkg.cloudflare.com/cloudflared
    suites: any
    components: main
    signed_by: /usr/share/keyrings/cloudflare-main.gpg

- name: Install cloudflared
  ansible.builtin.apt:
    name: cloudflared
    install_recommends: false
    update_cache: true
  register: result
  until: result is succeeded

- name: Copy cloudflared systemd unit file into place
  ansible.builtin.template:
    src: files/etc/systemd/system/cloudflared.service
    dest: /etc/systemd/system/cloudflared.service
    mode: u=rw,g=r,o=r
  notify: Reload systemd

- name: Configure cloudflared
  ansible.builtin.copy:
    dest: /etc/default/cloudflared
    content: |
      CLOUDFLARED_TOKEN={{ cloudflared_tunnel_token }}
    mode: u=rw,g=,o=
  no_log: true
  notify: Restart cloudflared

#################################################
# Mosquitto
#################################################

- name: Add Mosquitto apt signing keys
  ansible.builtin.get_url:
    url: https://repo.mosquitto.org/debian/mosquitto-repo.gpg
    dest: /etc/apt/trusted.gpg.d/mosquitto-repo.asc
    mode: u=rw,g=r,o=r

- name: Add Mosquitto apt signing keys
  ansible.builtin.deb822_repository:
    name: mosquitto
    uris: https://repo.mosquitto.org/debian
    suites: "{{ ansible_distribution_release }}"
    components: [main]
    signed_by: /etc/apt/trusted.gpg.d/mosquitto-repo.asc

- name: Install mosquitto
  ansible.builtin.apt:
    name: mosquitto
    install_recommends: false
    update_cache: true
  register: result
  until: result is succeeded

- name: Create '/etc/mosquitto/conf.d/my.conf' file
  ansible.builtin.copy:
    dest: /etc/mosquitto/conf.d/my.conf
    content: |
      listener      1883
      protocol      mqtt
      password_file /etc/mosquitto/password_file
    mode: u=rw,g=,o=
    owner: mosquitto
    group: mosquitto
  notify: Restart mosquitto

- name: Create '/etc/mosquitto/password_file' file
  ansible.builtin.template:
    dest: /etc/mosquitto/password_file
    src: files/etc/mosquitto/password_file.j2
    mode: u=rw,g=,o=
    owner: mosquitto
    group: mosquitto
  no_log: true
  notify: Restart mosquitto
  changed_when: false

#################################################
# Zigbee2MQTT
#################################################

- name: Create Zigbee2MQTT directory (/var/lib/zigbee2mqtt)
  ansible.builtin.file:
    path: /var/lib/zigbee2mqtt
    state: directory
    recurse: true

- name: Configure Zigbee2MQTT (/var/lib/zigbee2mqtt/configuration.yaml)
  ansible.builtin.template:
    dest: /var/lib/zigbee2mqtt/configuration.yaml
    src: files/var/lib/zigbee2mqtt/configuration.yaml.j2
    mode: u=rw,g=r,o=r
  no_log: true
  notify: Restart zigbee2mqtt

- name: Copy the Zigbee2MQTT database (/var/lib/zigbee2mqtt/database.db)
  ansible.builtin.copy:
    dest: /var/lib/zigbee2mqtt/database.db
    src: files/var/lib/zigbee2mqtt/database.db
    mode: u=rw,g=r,o=r
  no_log: true
  notify: Restart zigbee2mqtt

- name: Zigbee2MQTT container
  community.docker.docker_container:
    name: zigbee2mqtt
    image: docker.io/koenkk/zigbee2mqtt:2.7.2@sha256:60a295b40f4e7fb7ab4d995932369e50f2529837272fa4979e986ec1ffdb7fce
    comparisons:
      image: strict
      labels: allow_more_present
      volumes: allow_more_present
    volumes:
      - /run/dbus:/run/dbus:ro
      - /var/lib/zigbee2mqtt:/app/data
    ports:
      - 8082:8080
    env:
      TZ: "{{ timezone }}"
    labels:
      homepage.group: Containers
      homepage.name: Zigbee2MQTT
      homepage.icon: https://raw.githubusercontent.com/Koenkk/zigbee2mqtt.io/bfd27df45e931d18675eb5aba8bdcbaf688a608f/docs/images/logo.png
      homepage.description: Zigbee to MQTT bridge
    restart_policy: always
    timeout: "{{ docker_container_timeout }}"
  notify: Restart zigbee2mqtt

#################################################
# ESPHome
#################################################

- name: Create ESPHome directory (/var/lib/esphome/config)
  ansible.builtin.file:
    path: /var/lib/esphome/config
    state: directory
    recurse: true

- name: Configure ESPHome (/var/lib/esphome/config/apollo-msr-2.yaml)
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: u=rw,g=r,o=r
  loop:
    - dest: /var/lib/esphome/config/apollo-msr-2-f585f4.yaml
      src: files/var/lib/esphome/config/apollo-msr-2-f585f4.yaml.j2
  notify: Restart esphome

- name: Create secret file for ESPHome
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: u=rw,g=,o=
  loop:
    - dest: /var/lib/esphome/config/secrets.yaml
      src: files/var/lib/esphome/config/secrets.yaml.j2
  no_log: true
  notify: Restart esphome

- name: ESPHome container
  community.docker.docker_container:
    name: esphome
    image: ghcr.io/esphome/esphome:2025.11.5@sha256:a22312011695efb5c37680682654c1b5cd2dcec4804ba5f3d4af5dd9093e592f
    comparisons:
      image: strict
      labels: allow_more_present
      volumes: allow_more_present
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/lib/esphome/config:/config
    # This is needed for the mDNS - no autodiscovery without it
    network_mode: host
    env:
      USERNAME: "{{ esphome_web_server_username }}"
      PASSWORD: "{{ esphome_web_server_password }}"
    labels:
      homepage.group: Containers
      homepage.name: ESPHome
      homepage.icon: https://raw.githubusercontent.com/esphome/esphome-docs/e28345cd8f1c9380bc25dd977fcf443ba5c8612c/images/logo.svg
      homepage.description: ESPHome is a system to control your ESP8266/ESP32 by simple yet powerful configuration files and control them remotely through Home Automation systems.
    restart_policy: always
    timeout: "{{ docker_container_timeout }}"
  notify: Restart esphome

#################################################
# Home Assistant
#################################################

# - name: Download automation/blueprints files
#   ansible.builtin.get_url:
#     url: "{{ item }}"
#     dest: "{{ hass_config_directory }}/blueprints/automation/homeassistant/{{ item | basename }}"
#     mode: u=rw,g=r,o=r
#   loop:
#     - https://raw.githubusercontent.com/home-assistant/core/b07682e43cd2604ef387bae79bcae555b15516b8/homeassistant/components/automation/blueprints/motion_light.yaml
#     - https://raw.githubusercontent.com/home-assistant/core/b07682e43cd2604ef387bae79bcae555b15516b8/homeassistant/components/automation/blueprints/notify_leaving_zone.yaml
#   notify: Restart hass

# - name: Copy config files for Home Assistant to {{ hass_config_directory }}/
#   ansible.builtin.copy:
#     src: "{{ item }}"
#     dest: "{{ hass_config_directory }}/"
#     mode: u=rw,g=r,o=r
#   loop:
#     - files/{{ hass_config_directory }}/.storage
#     - files/{{ hass_config_directory }}/lovelace
#     - files/{{ hass_config_directory }}/known_devices.yaml
#     - files/{{ hass_config_directory }}/automations.yaml
#   notify: Restart hass

# - name: Create config files for Home Assistant to {{ hass_config_directory }}
#   ansible.builtin.template:
#     src: "{{ item.src }}"
#     dest: "{{ item.dest }}"
#     mode: u=rw,g=r,o=r
#   loop:
#     - dest: "{{ hass_config_directory }}/configuration.yaml"
#       src: files/{{ hass_config_directory }}/configuration.yaml.j2
#   notify: Restart hass

# - name: Create secret file for Home Assistant to {{ hass_config_directory }}
#   ansible.builtin.template:
#     src: "{{ item.src }}"
#     dest: "{{ item.dest }}"
#     mode: u=rw,g=,o=
#   loop:
#     - dest: "{{ hass_config_directory }}/secrets.yaml"
#       src: files/{{ hass_config_directory }}/secrets.yaml.j2
#   no_log: true
#   notify: Restart hass

# - name: Home Assistant container
#   community.docker.docker_container:
#     name: home-assistant
#     image: ghcr.io/home-assistant/home-assistant:2025.10.2@sha256:5ae78cf2e6d8b53439cac50ed184ff1336cfbbb878fce16f75589e048fcdcdd9
#     comparisons:
#       image: strict
#       labels: allow_more_present
#       volumes: allow_more_present
#     volumes:
#       - /etc/localtime:/etc/localtime:ro
#       - /run/dbus:/run/dbus:ro
#       - "{{ hass_config_directory }}:/config"
#     network_mode: host
#     privileged: true
#     labels:
#       homepage.group: Containers
#       homepage.name: Home Assistant
#       homepage.icon: https://upload.wikimedia.org/wikipedia/en/4/49/Home_Assistant_logo_%282023%29.svg
#       homepage.href: "{{ hass_url }}"
#       homepage.description: Open source home automation that puts local control and privacy first.
#     restart_policy: always
#     timeout: "{{ docker_container_timeout }}"
#   notify: Restart hass

# - name: Wait for HASS to be started
#   when: not hass_restore_log.stat.exists
#   ansible.builtin.wait_for:
#     port: 8123

# - name: Install HACS
#   when: not hass_restore_log.stat.exists
#   community.docker.docker_container_exec:
#     container: home-assistant
#     command: bash -c "wget -O - https://get.hacs.xyz | bash -"
#     chdir: /config
#   notify: Restart hass

#################################################
# Homepage
#################################################

# - name: Create homepage directory (/var/lib/homepage/config)
#   ansible.builtin.file:
#     path: /var/lib/homepage/config
#     state: directory
#     recurse: true

# - name: Copy config files for homepage to /var/lib/homepage/config
#   ansible.builtin.template:
#     src: "{{ item }}"
#     dest: "/var/lib/homepage/config/{{ item | basename | regex_replace('\\.j2$', '') }}"
#     mode: u=rw,g=r,o=r
#   with_fileglob:
#     - files/var/lib/homepage/config/*.j2
#   no_log: true
#   notify: Restart homepage

# - name: Homepage container
#   community.docker.docker_container:
#     name: homepage
#     image: ghcr.io/gethomepage/homepage:v1.5.0@sha256:e7fc26f914cf5e7dcd6c566e24ca218addb879aa76478ad4a553b1f9ae48b1d7
#     comparisons:
#       image: strict
#       labels: allow_more_present
#       volumes: allow_more_present
#     volumes:
#       - /var/lib/homepage/config:/app/config
#       - /var/run/docker.sock:/var/run/docker.sock:ro
#     network_mode: host
#     privileged: true
#     env:
#       LOG_TARGETS: stdout
#       HOMEPAGE_ALLOWED_HOSTS: "*"
#     labels:
#       homepage.group: Containers
#       homepage.name: Homepage
#       homepage.icon: https://raw.githubusercontent.com/gethomepage/homepage/47765ee05e633c87fcf8fca8ee1293bf0ef6bb3e/docs/assets/light_squircle%402x.png
#       homepage.href: https://rpi.xvx.cz/
#       homepage.description: A modern, fully static, fast, secure fully proxied, highly customizable application dashboard with integrations for over 100 services and translations into multiple languages.
#     restart_policy: always
#     timeout: "{{ docker_container_timeout }}"
#   notify: Restart homepage

#################################################
# Kodi
#################################################

- name: Add kodi group
  ansible.builtin.group:
    name: kodi

- name: Add kodi user
  ansible.builtin.user:
    name: kodi
    comment: Kodi
    shell: /usr/bin/sh
    groups: audio,bluetooth,input,uucp,video,plugdev
    group: kodi
  register: created_user_kodi

- name: Create /home/kodi/.config/wireplumber/wireplumber.conf.d directory
  ansible.builtin.file:
    path: /var/lib/bluetooth/{{ bluetooth_device_address_rpi }}/{{ bluetooth_device_address_headset }}
    state: directory
    mode: u=rwx,g=,o=

- name: Copy audio profile for bluetooth device
  ansible.builtin.copy:
    src: files/var/lib/bluetooth/{{ bluetooth_device_address_rpi }}/{{ bluetooth_device_address_headset }}/info
    dest: /var/lib/bluetooth/{{ bluetooth_device_address_rpi }}/{{ bluetooth_device_address_headset }}/info
    mode: u=rw,g=,o=
  no_log: true

- name: Create wireplumber config directory
  ansible.builtin.file:
    path: /home/kodi/.config/wireplumber/wireplumber.conf.d
    state: directory
    owner: kodi
    group: kodi
    mode: u=rwx,g=rx,o=rx

- name: Create wireplumber state directory
  ansible.builtin.file:
    path: /home/kodi/.local/state/wireplumber
    state: directory
    owner: kodi
    group: kodi
    mode: u=rwx,g=,o=

- name: Configure WirePlumber audio settings
  ansible.builtin.template:
    src: files/home/kodi/.config/wireplumber/wireplumber.conf.d/50-audio.conf.j2
    dest: /home/kodi/.config/wireplumber/wireplumber.conf.d/50-audio.conf
    owner: kodi
    group: kodi
    mode: u=rw,g=r,o=r

- name: Configure WirePlumber default profile
  ansible.builtin.template:
    src: files/home/kodi/.local/state/wireplumber/default-profile.j2
    dest: /home/kodi/.local/state/wireplumber/default-profile
    owner: kodi
    group: kodi
    mode: u=rw,g=rw,o=r

- name: Get UID of kodi user
  ansible.builtin.shell: id -u kodi
  register: kodi_uid_result
  changed_when: false

- name: Enable and start PipeWire for user kodi
  become: true
  become_user: kodi
  ansible.builtin.shell:
    cmd: systemctl --user --now enable pipewire pipewire-pulse
    creates: /usr/lib/systemd/user/pipewire.service
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ kodi_uid_result.stdout }}"

- name: Create startup script for Kodi
  ansible.builtin.copy:
    src: lib/systemd/system/kodi.service
    dest: /lib/systemd/system/kodi.service
    mode: u=rw,g=r,o=r
  notify:
    - Restart kodi

- name: Change default target to graphical.target
  ansible.builtin.file:
    src: /usr/lib/systemd/system/graphical.target
    dest: /etc/systemd/system/default.target
    state: link

- name: Copy Kodi configuration files
  ansible.posix.synchronize:
    src: home/kodi/.kodi
    dest: /home/kodi/
  # These files are frequently updated by Kodi
  changed_when: false
  notify: Restart kodi

- name: Additional Kodi configuration
  ansible.builtin.template:
    dest: "{{ item.dest }}"
    src: "{{ item.src }}"
    mode: u=rw,g=,o=
  loop:
    # This file is frequently updated by Kodi
    - dest: /home/kodi/.kodi/userdata/guisettings.xml
      src: files/home/kodi/.kodi/userdata/guisettings.xml.j2
    - dest: /home/kodi/.kodi/userdata/sources.xml
      src: files/home/kodi/.kodi/userdata/sources.xml.j2
  changed_when: false

- name: Chown "/home/kodi"
  ansible.builtin.file:
    path: /home/kodi
    owner: kodi
    group: kodi
    recurse: true
  changed_when: false

# It happens sometimes, that the Kodi don't start for the first time - SubState": "dead"
- name: Start Kodi
  ansible.builtin.systemd_service:
    name: kodi
    state: started
    enabled: true
  register: result
  until: result.status.SubState == "running"

- name: Wait for Kodi to be started
  ansible.builtin.wait_for:
    port: 8080

- name: Enable Kodi Visualization addon spectrum
  ansible.builtin.command: sqlite3 /home/kodi/.kodi/userdata/Database/Addons33.db "UPDATE installed SET enabled = 1 WHERE addonID = '{{ item }}'"
  loop:
    - visualization.spectrum
  register: result
  until: result is succeeded
  delay: 10
  changed_when: false

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Wait for Kodi to be started
  ansible.builtin.wait_for:
    port: 8080

- name: Refresh Music Library
  no_log: true
  # checkov:skip=CKV2_ANSIBLE_1
  ansible.builtin.uri:
    url: http://{{ ansible_host }}:8080/jsonrpc
    user: kodi
    password: "{{ kodi_guisettings_services_webserverpassword }}"
    method: POST
    body: '{ "jsonrpc": "2.0", "method": "AudioLibrary.Scan", "id": "ansible" }'
    force_basic_auth: true
    body_format: json

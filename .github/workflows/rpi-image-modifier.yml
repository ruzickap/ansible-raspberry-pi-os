---
name: rpi-image-modifier

on:
  workflow_dispatch:

permissions: read-all

env:
  RASPBERRY_PI_OS_VERSION: "2024-03-15"
  FIRST_USER_NAME: pi
  FIRST_USER_PASS: raspberry
  WIFI_SSID: "ruzickovi 2.4 GHz"
  WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}

jobs:
  rpi-image-modifier:
    runs-on: ubuntu-latest
    steps:
      - name: Change Raspberry Pi OS
        uses: dtcooper/rpi-image-modifier@745a9b5b056f781978676f1c0f935ff47daddf03 # v1.3.0
        id: create-image
        with:
          base-image-url: https://downloads.raspberrypi.com/raspios_lite_arm64/images/raspios_lite_arm64-${{ env.RASPBERRY_PI_OS_VERSION }}/${{ env.RASPBERRY_PI_OS_VERSION }}-raspios-bookworm-arm64-lite.img.xz
          image-path: ${{ env.RASPBERRY_PI_OS_VERSION }}-raspios-bookworm-arm64-lite-modified.img
          env-vars: FIRST_USER_NAME,FIRST_USER_PASS,WIFI_SSID,WIFI_PASSWORD
          run: |
            set -euxo pipefail

            cat > "/etc/NetworkManager/system-connections/${WIFI_SSID}.nmconnection" << EOF
            [connection]
            id=${WIFI_SSID}
            uuid=5a62d13a-fdf8-4737-8f7d-f43764685207
            type=wifi
            interface-name=wlan0
            autoconnect=true

            [wifi]
            mode=infrastructure
            ssid=${WIFI_SSID}

            [wifi-security]
            auth-alg=open
            key-mgmt=wpa-psk
            psk=${WIFI_PASSWORD}

            [ipv4]
            method=manual
            address1=192.168.1.2/24,192.168.1.1
            dns=8.8.8.8;1.1.1.1;
            EOF
            chmod 600 "/etc/NetworkManager/system-connections/${WIFI_SSID}.nmconnection"

            echo "${FIRST_USER_NAME}:${FIRST_USER_PASS}" | chpasswd

            install -v -m 0700 -o 1000 -g 1000 -d "/home/${FIRST_USER_NAME}/.ssh"
            wget -q https://github.com/ruzickap.keys -O "/home/${FIRST_USER_NAME}/.ssh/authorized_keys"
            chown 1000:1000 "/home/${FIRST_USER_NAME}/.ssh/authorized_keys"
            chmod 0600 "/home/${FIRST_USER_NAME}/.ssh/authorized_keys"

            echo "Petr Ruzicka - petr.ruzicka@gmail.com" | tee -a /owner.txt > /boot/owner.txt
            systemctl enable ssh

            # This is not working as expected !!!
            # Silent installation during boot does not work !!!
            # I have no idea how to properly skip the rename-user during boot !!!

      - name: Upload build artifact
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: ${{ env.RASPBERRY_PI_OS_VERSION }}-raspios-bookworm-arm64-lite-modified.img
          path: ${{ steps.create-image.outputs.image-path }}
          if-no-files-found: error
          retention-days: 2
          compression-level: 9
          overwrite: true
